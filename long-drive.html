<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Drive - Optimized Storage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0b0b0b; --side: #141414; --accent: #0078d4;
            --brd: #222; --txt: #888; --bright: #eee; --danger: #d83b01;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); display: flex; height: 100vh; overflow: hidden; user-select: none; }
        .main-app { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .nav-bar { background: var(--side); padding: 10px 20px; border-bottom: 1px solid var(--brd); display: flex; align-items: center; gap: 15px; }
        
        .brand { 
            font-family: 'Poppins', sans-serif; 
            font-size: 22px; 
            font-weight: 900; 
            background: linear-gradient(90deg, #0078d4, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-right: 10px;
            white-space: nowrap;
            letter-spacing: -0.5px;
        }

        #explorer { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; align-content: start; position: relative; }
        .item { display: flex; flex-direction: column; align-items: center; padding: 15px 10px; cursor: pointer; border-radius: 8px; border: 1px solid transparent; text-align: center; position: relative; transition: 0.1s; z-index: 5; }
        .item:hover { background: rgba(255,255,255,0.05); }
        .item.selected { background: rgba(0, 120, 212, 0.3) !important; border: 1px solid var(--accent) !important; }
        .item.drag-over { background: rgba(0, 255, 0, 0.1) !important; border: 1px dashed #00ff00 !important; }
        .item.clip-cut { opacity: 0.4; }
        .item i { font-size: 48px; margin-bottom: 10px; pointer-events: none; }
        .fa-folder { color: #ffca28; } .fa-file { color: #00bcd4; }
        .item span { font-size: 12px; color: var(--bright); pointer-events: none; word-break: break-all; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.2; }
        
        .menu { position: fixed; background: #1c1c1c; border: 1px solid var(--brd); border-radius: 6px; padding: 6px 0; min-width: 220px; display: none; z-index: 10001; box-shadow: 0 10px 25px rgba(0,0,0,0.6); }
        .menu-btn { padding: 8px 16px; font-size: 13px; color: var(--bright); cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .menu-btn:hover { background: var(--accent); }
        .menu-btn div { display: flex; align-items: center; gap: 12px; }
        .menu-btn span { font-size: 10px; opacity: 0.5; }
        .menu-sep { height: 1px; background: var(--brd); margin: 6px 0; }

        #editor { position: fixed; right: 0; top: 0; bottom: 0; width: 50%; background: var(--side); border-left: 1px solid var(--brd); display: none; flex-direction: column; z-index: 10002; }
        textarea { flex: 1; background: #050505; color: #ddd; border: none; padding: 25px; font-family: 'Consolas', monospace; font-size: 14px; outline: none; resize: none; }

        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0); display: none; justify-content: center; align-items: flex-end; z-index: 20000; transition: background 0.3s; }
        .modal-bg.active { background: rgba(0,0,0,0.6); }
        .modal { background: #1c1c1c; padding: 25px; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; border: 1px solid var(--brd); border-bottom: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal.active { transform: translateY(0); }
        .modal input { width: 100%; box-sizing: border-box; background: #000; border: 1px solid var(--brd); color: #fff; padding: 14px; margin: 15px 0; outline: none; border-radius: 8px; font-size: 14px; }
        
        .btn { padding: 10px 24px; font-size: 13px; cursor: pointer; border-radius: 8px; border: none; background: #333; color: #fff; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .btn-p { background: var(--accent); }
        .btn-d { background: var(--danger); }
        #path { font-size: 13px; color: #777; flex: 1; }

        .loader { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="main-app">
    <div class="nav-bar">
        <div class="brand">Long Drive</div>
        <button class="btn" onclick="navUp()" id="back-btn"><i class="fas fa-arrow-left"></i> Go Back</button>
        <div id="path">/main</div>
        <input type="text" id="search-box" placeholder="Search..." oninput="syncData()" style="background:#000; border:1px solid #333; color:#fff; padding:5px 10px; border-radius:4px; font-size:12px; outline:none; width:150px;">
    </div>
    <div id="explorer" oncontextmenu="handleGlobalCtx(event)" onclick="handleBgClick(event)"></div>
</div>

<div id="editor">
    <div style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: #111; border-bottom: 1px solid var(--brd);">
        <span id="file-title" style="font-size: 13px; color: #fff; font-weight: bold;"></span>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-p" onclick="saveAndCloseEditor()"><i class="fas fa-save"></i> Save & Close (Ctrl+S)</button>
        </div>
    </div>
    <textarea id="txt-area" spellcheck="false"></textarea>
</div>

<div id="ctx" class="menu"></div>

<div id="modal-box" class="modal-bg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div id="modal-h" style="font-weight: bold; color: #fff; font-size: 16px;"></div>
        <input type="text" id="modal-i" spellcheck="false" autocomplete="off">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-p" onclick="submitModal()">Proceed</button>
        </div>
    </div>
</div>

<div id="dialog-box" class="modal-bg" onclick="closeDialog()">
    <div class="modal" onclick="event.stopPropagation()">
        <div id="dialog-h" style="font-weight: bold; color: #fff; font-size: 16px; margin-bottom: 8px;"></div>
        <div id="dialog-m" style="font-size: 13px; line-height: 1.4; margin-bottom: 25px; color: #aaa;"></div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn" onclick="closeDialog()">Cancel</button>
            <button class="btn btn-p" id="dialog-confirm">Confirm</button>
        </div>
    </div>
</div>

<div id="process-box" class="modal-bg">
    <div class="modal">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div class="loader"></div>
            <div>
                <div id="process-h" style="font-weight: bold; color: #fff; font-size: 15px;">Processing...</div>
                <div id="process-m" style="font-size: 12px; color: #777; margin-top: 4px;">Please wait a moment</div>
            </div>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://nynowiamkpddohtaoqvt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55bm93aWFta3BkZG9odGFvcXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MzQyODEsImV4cCI6MjA4MjIxMDI4MX0.vN7m2SUztxtHUROEMOqtbqMGRPehM9UJZP_VSsVMRtw';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const TBL = 'cloud_storage';

    let state = { cur: null, sel: [], clip: null, act: null, actFile: null, renameId: null, currentNodes: [], lastSel: null };

    const exp = document.getElementById('explorer');
    const ctx = document.getElementById('ctx');
    const mInput = document.getElementById('modal-i');

    async function syncData() {
        let req = sb.from(TBL).select('*').eq('store', 'main');
        const query = document.getElementById('search-box').value.toLowerCase();
        
        if (query) {
            req = req.ilike('name', `%${query}%`);
        } else {
            if (state.cur === null) req = req.is('pid', null);
            else req = req.eq('pid', state.cur);
        }

        const { data, error } = await req;
        if (!error) { state.currentNodes = data; render(); }
    }

    function render() {
        let data = [...state.currentNodes];
        data.sort((a, b) => (b.type === 'folder') - (a.type === 'folder') || a.name.localeCompare(b.name));
        
        exp.innerHTML = '';
        data.forEach((i, index) => {
            const div = document.createElement('div');
            div.className = `item ${state.sel.includes(i.id) ? 'selected' : ''} ${state.clip?.ids.includes(i.id) && state.clip.type === 'cut' ? 'clip-cut' : ''}`;
            div.dataset.id = i.id;
            div.dataset.index = index;
            div.draggable = true;
            div.innerHTML = `<i class="fas ${i.type === 'folder' ? 'fa-folder' : 'fa-file'}"></i><span>${i.name}</span>`;
            
            div.onclick = (e) => {
                e.stopPropagation(); hideCtx();
                handleSelection(e, i.id, index, data);
                updateSelectionUI();
            };
            div.ondblclick = () => { if (i.type === 'folder') { state.cur = i.id; state.sel = []; state.lastSel = null; syncData(); } else showEditor(i); };
            div.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); if(!state.sel.includes(i.id)) { state.sel = [i.id]; state.lastSel = index; } updateSelectionUI(); showCtx(e, i.type); };

            div.ondragstart = (e) => { if (!state.sel.includes(i.id)) { state.sel = [i.id]; updateSelectionUI(); } e.dataTransfer.setData('text/plain', 'drag'); };
            div.ondragover = (e) => { if (i.type === 'folder' && !state.sel.includes(i.id)) { e.preventDefault(); div.classList.add('drag-over'); } };
            div.ondragleave = () => div.classList.remove('drag-over');
            div.ondrop = async (e) => {
                e.preventDefault(); div.classList.remove('drag-over');
                showProcess('Moving...', `Moving ${state.sel.length} items to ${i.name}`);
                await sb.from(TBL).update({ pid: i.id }).in('id', state.sel);
                state.sel = []; state.lastSel = null; await syncData(); hideProcess();
            };

            exp.appendChild(div);
        });
        updateSelectionUI();
        updatePath();
        document.getElementById('back-btn').disabled = !state.cur;
    }

    function handleSelection(e, id, index, currentData) {
        if (e.ctrlKey) {
            state.sel.includes(id) ? state.sel = state.sel.filter(x => x !== id) : state.sel.push(id);
            state.lastSel = index;
        } else if (e.shiftKey && state.lastSel !== null) {
            const start = Math.min(state.lastSel, index);
            const end = Math.max(state.lastSel, index);
            const ids = currentData.slice(start, end + 1).map(item => item.id);
            state.sel = Array.from(new Set([...state.sel, ...ids]));
        } else {
            state.sel = [id];
            state.lastSel = index;
        }
    }

    function showCtx(e, type) {
        let h = type ? `
            <div class="menu-btn" onclick="previewFile()"><div><i class="fas fa-play"></i> Run / Preview</div><span>Ctrl+Q</span></div>
            <div class="menu-btn" onclick="downloadItems()"><div><i class="fas fa-download"></i> Download</div><span></span></div>
            <div class="menu-sep"></div>
            <div class="menu-btn" onclick="copy()"><div><i class="fas fa-copy"></i> Copy</div><span>Ctrl+C</span></div>
            <div class="menu-btn" onclick="cut()"><div><i class="fas fa-cut"></i> Cut</div><span>Ctrl+X</span></div>
            <div class="menu-btn" onclick="openRename()"><div><i class="fas fa-edit"></i> Rename</div><span>F2</span></div>
            <div class="menu-sep"></div>
            <div class="menu-btn" onclick="deleteNode()"><div><i class="fas fa-trash"></i> Delete</div><span>Del</span></div>
        ` : `
            <div class="menu-btn" onclick="syncData()"><div><i class="fas fa-sync"></i> Refresh</div><span></span></div>
            <div class="menu-sep"></div>
            <div class="menu-btn" onclick="openModal('folder')"><div><i class="fas fa-folder-plus"></i> New Folder</div><span>F</span></div>
            <div class="menu-btn" onclick="openModal('file')"><div><i class="fas fa-file-circle-plus"></i> New File</div><span>N</span></div>
            <div class="menu-sep"></div>
            <div class="menu-btn ${!state.clip ? 'disabled' : ''}" onclick="paste()"><div><i class="fas fa-paste"></i> Paste</div><span>Ctrl+V</span></div>
        `;
        ctx.innerHTML = h; ctx.style.display = 'block'; 
        ctx.style.left = e.clientX + 'px'; ctx.style.top = e.clientY + 'px';
    }

    function openSlideModal(id) {
        const bg = document.getElementById(id);
        const md = bg.querySelector('.modal');
        bg.style.display = 'flex';
        setTimeout(() => { bg.classList.add('active'); md.classList.add('active'); }, 10);
    }

    function closeSlideModal(id) {
        const bg = document.getElementById(id);
        if(!bg) return;
        const md = bg.querySelector('.modal');
        bg.classList.remove('active');
        md.classList.remove('active');
        setTimeout(() => { bg.style.display = 'none'; }, 300);
    }

    function showProcess(title, msg) {
        document.getElementById('process-h').innerText = title;
        document.getElementById('process-m').innerText = msg;
        openSlideModal('process-box');
    }

    function hideProcess() { closeSlideModal('process-box'); }

    function openModal(t) {
        state.act = t;
        document.getElementById('modal-h').innerText = 'Create ' + (t === 'folder' ? 'Folder' : 'File');
        openSlideModal('modal-box');
        setTimeout(() => mInput.focus(), 100);
        hideCtx();
    }

    function closeModal() { closeSlideModal('modal-box'); mInput.value = ''; }

    function customConfirm(title, message, onConfirm) {
        document.getElementById('dialog-h').innerText = title;
        document.getElementById('dialog-m').innerText = message;
        const confirmBtn = document.getElementById('dialog-confirm');
        confirmBtn.onclick = () => { onConfirm(); closeDialog(); };
        openSlideModal('dialog-box');
        confirmBtn.focus();
    }

    function closeDialog() { closeSlideModal('dialog-box'); }

    async function submitModal() {
        const n = mInput.value.trim(); if(!n) return;
        showProcess('Saving...', 'Creating your new item');
        if (state.act === 'rename') await sb.from(TBL).update({ name: n }).eq('id', state.renameId);
        else await sb.from(TBL).insert([{ name: n, type: state.act, pid: state.cur, store: 'main' }]);
        closeModal(); await syncData(); hideProcess();
    }

    async function deleteNode() {
        if(state.sel.length === 0) return;
        customConfirm('Delete Items', `Are you sure you want to delete ${state.sel.length} item(s)?`, async () => {
            showProcess('Deleting...', `Removing ${state.sel.length} item(s)`);
            await sb.from(TBL).delete().in('id', state.sel);
            state.sel = []; state.lastSel = null; await syncData(); hideCtx(); hideProcess();
        });
    }

    function triggerDownload(name, content) {
        const blob = new Blob([content || ''], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function downloadItems() {
        if (state.sel.length === 0) return;
        hideCtx();
        showProcess('Downloading...', `Preparing ${state.sel.length} item(s)`);
        for (const id of state.sel) {
            const item = state.currentNodes.find(n => n.id === id);
            if (!item) continue;
            if (item.type === 'file') {
                triggerDownload(item.name, item.content);
            } else {
                const { data: children } = await sb.from(TBL).select('name, content').eq('pid', item.id).eq('type', 'file');
                children?.forEach(child => triggerDownload(child.name, child.content));
            }
        }
        setTimeout(hideProcess, 1000);
    }

    function previewFile() {
        if (state.sel.length === 0) return;
        const node = state.currentNodes.find(n => n.id === state.sel[0]);
        if (!node || node.type === 'folder') return;
        const previewWin = window.open('', '_blank');
        previewWin.document.open();
        previewWin.document.write(node.content || '');
        previewWin.document.close();
        hideCtx();
    }

    function updateSelectionUI() { document.querySelectorAll('.item').forEach(el => el.classList.toggle('selected', state.sel.includes(el.dataset.id))); }
    
    async function updatePath() {
        let p = '/main';
        if(state.cur) { 
            const { data } = await sb.from(TBL).select('name').eq('id', state.cur).single();
            if (data) p += ' / ' + data.name;
        }
        document.getElementById('path').innerText = p;
    }

    function handleBgClick(e) { if(e.target === exp) { state.sel = []; state.lastSel = null; updateSelectionUI(); } hideCtx(); }
    function copy() { state.clip = { type: 'copy', ids: [...state.sel] }; render(); hideCtx(); }
    function cut() { state.clip = { type: 'cut', ids: [...state.sel] }; render(); hideCtx(); }
    
    async function paste() {
        if (!state.clip) return;
        showProcess('Pasting...', 'Processing items');
        if (state.clip.type === 'copy') {
            const { data } = await sb.from(TBL).select('*').in('id', state.clip.ids);
            for (const item of data) {
                const { id, created_at, ...clean } = item;
                await sb.from(TBL).insert([{ ...clean, id: crypto.randomUUID(), pid: state.cur, name: item.name + ' - Copy' }]);
            }
        } else { await sb.from(TBL).update({ pid: state.cur }).in('id', state.clip.ids); state.clip = null; }
        await syncData(); hideCtx(); hideProcess();
    }

    async function navUp() { 
        if (state.cur) { 
            const { data } = await sb.from(TBL).select('pid').eq('id', state.cur).single();
            state.cur = data ? data.pid : null;
            state.sel = []; state.lastSel = null; 
            await syncData();
        } 
    }

    function openRename() {
        const item = state.currentNodes.find(n => n.id === state.sel[0]);
        if(!item) return;
        state.act = 'rename'; state.renameId = item.id;
        document.getElementById('modal-h').innerText = 'Rename';
        mInput.value = item.name; openSlideModal('modal-box');
        setTimeout(() => mInput.focus(), 100); hideCtx();
    }

    async function showEditor(i) {
        state.actFile = i.id;
        document.getElementById('editor').style.display = 'flex';
        document.getElementById('file-title').innerText = i.name;
        const { data } = await sb.from(TBL).select('content').eq('id', i.id).single();
        document.getElementById('txt-area').value = data?.content || '';
    }

    async function saveAndCloseEditor() {
        if (!state.actFile) return;
        showProcess('Saving...', 'Updating file content');
        await sb.from(TBL).update({ content: document.getElementById('txt-area').value }).eq('id', state.actFile);
        document.getElementById('editor').style.display = 'none';
        state.actFile = null;
        await syncData();
        hideProcess();
    }

    window.onkeydown = (e) => {
        const mBox = document.getElementById('modal-box');
        const dBox = document.getElementById('dialog-box');
        const isEditing = document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA';
        
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            if (state.actFile) saveAndCloseEditor();
            else syncData();
            return;
        }

        if (e.key === 'Enter') {
            if (mBox.style.display === 'flex') { submitModal(); return; }
            if (dBox.style.display === 'flex') { document.getElementById('dialog-confirm').click(); return; }
            if (!isEditing && state.sel.length > 0) {
                const item = state.currentNodes.find(n => n.id === state.sel[0]);
                if (item) {
                    if (item.type === 'folder') { state.cur = item.id; state.sel = []; state.lastSel = null; syncData(); }
                    else showEditor(item);
                }
                return;
            }
        }
        
        if (e.key === 'Escape') { closeModal(); closeDialog(); return; }

        if (!isEditing) {
            const data = [...state.currentNodes].sort((a, b) => (b.type === 'folder') - (a.type === 'folder') || a.name.localeCompare(b.name));
            const grid = document.getElementById('explorer');
            const cols = window.getComputedStyle(grid).getPropertyValue('grid-template-columns').split(' ').length;

            if (['ArrowRight', 'ArrowLeft', 'ArrowDown', 'ArrowUp'].includes(e.key)) {
                e.preventDefault();
                let nextIdx = 0;
                if (state.lastSel !== null) {
                    if (e.key === 'ArrowRight') nextIdx = state.lastSel + 1;
                    else if (e.key === 'ArrowLeft') nextIdx = state.lastSel - 1;
                    else if (e.key === 'ArrowDown') nextIdx = state.lastSel + cols;
                    else if (e.key === 'ArrowUp') nextIdx = state.lastSel - cols;
                }
                
                if (nextIdx >= 0 && nextIdx < data.length) {
                    state.sel = [data[nextIdx].id];
                    state.lastSel = nextIdx;
                    updateSelectionUI();
                    const targetEl = document.querySelector(`[data-id="${data[nextIdx].id}"]`);
                    if (targetEl) targetEl.scrollIntoView({ block: 'nearest' });
                }
                return;
            }

            if (e.key.toLowerCase() === 'n') { e.preventDefault(); openModal('file'); return; }
            if (e.key.toLowerCase() === 'f') { e.preventDefault(); openModal('folder'); return; }
            if (e.ctrlKey && e.key === 'q') { e.preventDefault(); previewFile(); }
            if (e.key === 'Delete') deleteNode();
            if (e.key === 'F2') openRename();
            if (e.ctrlKey && e.key === 'c') copy();
            if (e.ctrlKey && e.key === 'x') cut();
            if (e.ctrlKey && e.key === 'v') paste();
            if (e.key === 'Backspace') navUp();
        }
    };

    function handleGlobalCtx(e) { hideCtx(); showCtx(e, null); }
    function hideCtx() { ctx.style.display = 'none'; }
    syncData();
</script>
</body>
</html>
