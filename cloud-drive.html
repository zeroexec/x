<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Explorer Pro - Ultra Fast</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;900&family=Consolas&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0b0b0b;
            --side: #111;
            --accent: #0078d4;
            --accent-hover: #006cc1;
            --brd: #2a2a2a;
            --txt: #aaa;
            --bright: #fff;
            --danger: #d83b01;
            --hover: #1f1f1f;
            --modal-bg: #161616;
        }

        /* --- Global Reset & Scrollbar --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--txt); display: flex; height: 100vh; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* --- Layout Structure --- */
        .sidebar {
            width: 320px; min-width: 320px;
            background: var(--side); border-right: 1px solid var(--brd);
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000; will-change: transform;
        }

        .main-app {
            flex: 1; display: flex; flex-direction: column;
            background: #000; overflow: hidden; min-width: 0; position: relative;
        }

        .nav-bar {
            background: var(--side); padding: 0 16px;
            border-bottom: 1px solid var(--brd);
            display: flex; align-items: center; gap: 12px;
            height: 60px; flex-shrink: 0;
        }

        .brand {
            font-family: 'Poppins', sans-serif; font-size: 18px; font-weight: 900;
            background: linear-gradient(90deg, #0078d4, #00f2fe);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-right: auto; letter-spacing: -0.5px;
        }

        /* --- Components: Buttons & Inputs --- */
        .btn-icon {
            background: transparent; border: none; color: #888;
            font-size: 16px; cursor: pointer; padding: 8px;
            border-radius: 6px; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }

        .add-btn {
            background: var(--accent); color: #fff;
            width: 34px; height: 34px; border-radius: 8px; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .add-btn:hover { background: var(--accent-hover); }

        .btn {
            padding: 10px 18px; font-size: 13px; cursor: pointer;
            border-radius: 8px; border: none; background: #2a2a2a; color: #fff;
            font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { background: #383838; }
        .btn-p { background: var(--accent); }
        .btn-p:hover { background: var(--accent-hover); }

        /* --- Explorer & Items --- */
        .search-container { padding: 12px 15px; border-bottom: 1px solid transparent; }
        #search-box {
            width: 100%; background: #080808; border: 1px solid var(--brd);
            color: #fff; padding: 10px 12px; border-radius: 8px; font-size: 13px;
            transition: border-color 0.2s;
        }
        #search-box:focus { border-color: var(--accent); }

        .path-container {
            padding: 8px 15px; background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--brd); display: flex; align-items: center;
            gap: 6px; overflow-x: auto; white-space: nowrap; height: 40px; flex-shrink: 0;
        }
        .path-segment {
            font-size: 11px; color: #666; cursor: pointer;
            padding: 2px 6px; border-radius: 4px; transition: 0.2s;
        }
        .path-segment:hover { background: rgba(255,255,255,0.05); color: #bbb; }
        .path-segment.active { color: #fff; font-weight: 600; cursor: default; }

        #explorer { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; }
        
        .item {
            display: flex; align-items: center; padding: 12px 15px;
            cursor: pointer; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.02);
            transition: background 0.1s; position: relative;
        }
        .item:hover { background: var(--hover); }
        .item.selected { background: rgba(0, 120, 212, 0.15) !important; border-left: 3px solid var(--accent); }
        .item.clip-cut { opacity: 0.5; filter: grayscale(1); }
        .item i.icon { width: 20px; text-align: center; }
        .item span { font-size: 13px; color: #ddd; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .more-btn {
            padding: 6px; color: #555; border-radius: 4px;
            cursor: pointer; opacity: 0; transition: 0.2s;
        }
        .item:hover .more-btn { opacity: 1; }
        .more-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }

        /* --- Editor --- */
        #editor { flex: 1; display: flex; flex-direction: column; background: #050505; position: relative; }
        textarea {
            flex: 1; background: transparent; color: #ccc; border: none;
            padding: 24px; font-family: 'Consolas', monospace; font-size: 14px;
            line-height: 1.6; resize: none;
        }
        
        /* --- Context Menu --- */
        .menu {
            position: fixed; background: #1c1c1c; border: 1px solid var(--brd);
            border-radius: 8px; padding: 6px; min-width: 180px;
            display: none; z-index: 99999; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        }
        .menu-btn {
            padding: 10px 12px; font-size: 13px; color: #ccc; border-radius: 6px;
            cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.1s;
        }
        .menu-btn:hover { background: var(--accent); color: #fff; }
        .menu-sep { height: 1px; background: #333; margin: 4px 0; }

        /* --- Floating UI --- */
        #paste-btn {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--accent); color: #fff; padding: 12px 24px;
            border-radius: 50px; cursor: pointer; display: none;
            box-shadow: 0 10px 25px rgba(0,120,212,0.4); z-index: 5000;
            align-items: center; gap: 10px; font-weight: bold; border: none;
            transition: transform 0.2s;
        }
        #paste-btn:hover { transform: translateY(-2px); }

        /* --- Toast --- */
        #toast-container {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: none; display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: #222; border: 1px solid #333; color: #fff;
            padding: 12px 20px; border-radius: 50px; display: flex; align-items: center;
            gap: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            pointer-events: auto; min-width: 300px;
            animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Modals Optimized (Anti-Lag) --- */
        .modal-bg {
            position: fixed; inset: 0; z-index: 10000;
            display: flex; justify-content: center; align-items: flex-end;
            background: rgba(0,0,0,0); backdrop-filter: blur(0px);
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s ease, background 0.3s ease, backdrop-filter 0.3s;
        }
        .modal-bg.active {
            opacity: 1; visibility: visible; pointer-events: auto;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
        }
        
        .modal {
            background: var(--modal-bg); padding: 25px; border-radius: 24px 24px 0 0;
            width: 100%; max-width: 480px; border: 1px solid var(--brd);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform; margin-bottom: 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .modal-bg.active .modal { transform: translateY(0); }

        .choice-card { display: flex; gap: 12px; margin-top: 20px; }
        .choice {
            flex: 1; background: #222; padding: 25px; border-radius: 16px;
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .choice:hover { border-color: var(--accent); background: #282828; }
        .choice i { font-size: 24px; margin-bottom: 10px; display: block; }
        
        .modal-input {
            width: 100%; background: #080808; border: 1px solid #333;
            color: #fff; padding: 14px; margin: 20px 0; border-radius: 12px; font-size: 16px;
        }
        .modal-input:focus { border-color: var(--accent); }

        /* --- Responsive --- */
        @media (min-width: 769px) { .menu-toggle, .sidebar-overlay { display: none !important; } }
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 280px; border-right: none; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay {
                display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
                z-index: 999; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s;
            }
            .sidebar-overlay.active { display: block; opacity: 1; }
            .modal { border-radius: 20px 20px 0 0; padding: 20px; }
        }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="nav-bar">
        <div class="brand"><i class="fas fa-cloud" style="margin-right:8px"></i>CloudPro</div>
        <button class="add-btn" onclick="openAddModal()"><i class="fas fa-plus"></i></button>
    </div>
    
    <div class="path-container" id="breadcrumb"></div>

    <div class="search-container">
        <input type="text" id="search-box" placeholder="Search files..." oninput="handleSearch()">
    </div>

    <div id="explorer" onclick="hideCtx()"></div>
</aside>

<main class="main-app">
    <div class="nav-bar">
        <button class="btn-icon menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div id="editor-header" style="flex:1; display:flex; justify-content: space-between; align-items: center; visibility: hidden; opacity: 0; transition: opacity 0.2s;">
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <span id="file-title" style="font-weight:bold; color:#fff; font-size:14px"></span>
                <span style="font-size:11px; color:#555">Editing...</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-p" onclick="saveEditor()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" onclick="closeEditor()"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>
    <div id="editor">
        <div id="placeholder" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.15; pointer-events: none;">
            <i class="fas fa-cloud-upload-alt" style="font-size:80px; margin-bottom:20px;"></i>
            <p style="font-size:18px;">Select a file to start editing</p>
        </div>
        <textarea id="txt-area" spellcheck="false" style="display: none;"></textarea>
    </div>
</main>

<button id="paste-btn" onclick="paste()"><i class="fas fa-paste"></i> Paste Here</button>
<div id="ctx" class="menu"></div>
<div id="toast-container"></div>

<div id="add-modal" class="modal-bg" onclick="closeAddModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <span style="font-weight:900; color:#fff; font-size:20px">Create New</span>
            <button class="btn-icon" onclick="closeAddModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="choice-card">
            <div class="choice" onclick="setCreateType('file')">
                <i class="fas fa-file-alt" style="color:#00bcd4"></i>
                <div style="font-weight:bold; color:#fff">File</div>
            </div>
            <div class="choice" onclick="setCreateType('folder')">
                <i class="fas fa-folder" style="color:#ffca28"></i>
                <div style="font-weight:bold; color:#fff">Folder</div>
            </div>
        </div>
    </div>
</div>

<div id="modal-box" class="modal-bg" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div id="modal-h" style="font-weight:900; color:#fff; font-size:20px; margin-bottom:5px"></div>
        <div style="font-size:13px; color:#666">Please enter a name for this item.</div>
        
        <input type="text" id="modal-i" class="modal-input" autocomplete="off" placeholder="Enter name...">
        
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-p" onclick="submitModal()">Confirm</button>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://nynowiamkpddohtaoqvt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55bm93aWFta3BkZG9odGFvcXZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MzQyODEsImV4cCI6MjA4MjIxMDI4MX0.vN7m2SUztxtHUROEMOqtbqMGRPehM9UJZP_VSsVMRtw';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let state = { 
        cur: null, 
        sel: [], 
        clip: null, 
        act: null, 
        actFile: null, 
        renameId: null, 
        allNodes: [], 
        searchTimer: null 
    };

    const explorer = document.getElementById('explorer');
    const ctx = document.getElementById('ctx');
    const mInput = document.getElementById('modal-i');

    // --- UI Logic ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
    }

    // Debounce for smooth search
    function handleSearch() {
        clearTimeout(state.searchTimer);
        state.searchTimer = setTimeout(render, 300);
    }

    async function syncData() {
        explorer.innerHTML = '<div style="padding:20px; text-align:center; color:#555"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>';
        const { data, error } = await sb.from('fs_nodes').select('*').eq('store', 'main');
        if(!error) {
            state.allNodes = data || []; 
            render();
        } else {
            showToast("Failed to sync data", null);
        }
    }

    function render() {
        const query = document.getElementById('search-box').value.toLowerCase();
        let data = state.allNodes.filter(n => n.pid === state.cur);
        
        // Filter if searching
        if (query) {
            data = state.allNodes.filter(n => n.name.toLowerCase().includes(query));
        } else {
            // Sort: Folders first, then name
            data.sort((a, b) => (b.type === 'folder') - (a.type === 'folder') || a.name.localeCompare(b.name));
        }
        
        explorer.innerHTML = '';
        
        if(data.length === 0) {
            explorer.innerHTML = `<div style="padding:40px 20px; text-align:center; opacity:0.4; font-size:13px"><i class="fas fa-inbox" style="font-size:24px; margin-bottom:10px; display:block"></i>Empty Directory</div>`;
        }

        const fragment = document.createDocumentFragment();

        data.forEach(i => {
            const div = document.createElement('div');
            // Optimasi: Gunakan dataset.id untuk selektor yang lebih akurat
            div.dataset.id = i.id;
            div.className = `item ${state.sel.includes(i.id) ? 'selected' : ''} ${state.clip?.ids.includes(i.id) && state.clip.type === 'cut' ? 'clip-cut' : ''}`;
            
            const iconColor = i.type === 'folder' ? '#ffca28' : '#00bcd4';
            const iconClass = i.type === 'folder' ? 'fa-folder' : 'fa-file-alt';

            div.innerHTML = `
                <i class="fas ${iconClass} icon" style="color:${iconColor}"></i>
                <span>${i.name}</span>
                <div class="more-btn" onclick="showCtx(event, '${i.id}')"><i class="fas fa-ellipsis-v"></i></div>
            `;
            
            // Event Delegation via onclick attribute is okay here, but direct bind helps scoping
            div.onclick = (e) => {
                if(e.target.closest('.more-btn')) return; // Prevent bubble
                handleItemClick(i);
            };
            fragment.appendChild(div);
        });
        explorer.appendChild(fragment);
        updateBreadcrumbs();
    }

    function handleItemClick(i) {
        state.sel = [i.id]; 
        updateSelectionUI();
        if (i.type === 'folder') { 
            state.cur = i.id; 
            state.sel = []; 
            // Clear search when entering folder
            if(document.getElementById('search-box').value) {
                document.getElementById('search-box').value = '';
            }
            render(); 
        } else {
            openInEditor(i);
        }
    }

    function updateBreadcrumbs() {
        const container = document.getElementById('breadcrumb');
        let html = '<span class="path-segment ' + (!state.cur ? 'active' : '') + '" onclick="navTo(null)"><i class="fas fa-home"></i> Home</span>';
        
        if (state.cur) {
            let path = []; 
            let curr = state.allNodes.find(n => n.id === state.cur);
            // Protect against orphan nodes loop
            let safety = 0;
            while (curr && safety < 50) { 
                path.unshift(curr); 
                curr = state.allNodes.find(n => n.id === curr.pid);
                safety++;
            }
            path.forEach(n => {
                const isActive = n.id === state.cur ? 'active' : '';
                html += ` <i class="fas fa-chevron-right" style="font-size:8px; opacity:0.3; margin:0 5px"></i> <span class="path-segment ${isActive}" onclick="navTo('${n.id}')">${n.name}</span>`;
            });
        }
        container.innerHTML = html;
        // Scroll to end of breadcrumbs
        container.scrollLeft = container.scrollWidth;
    }

    function navTo(id) { 
        state.cur = id; 
        state.sel = []; 
        document.getElementById('search-box').value = '';
        render(); 
    }

    // --- Context Menu ---
    window.showCtx = function(e, id) {
        e.stopPropagation(); 
        const node = state.allNodes.find(n => n.id === id);
        state.sel = [id]; 
        updateSelectionUI();
        
        // Dynamic Menu
        ctx.innerHTML = `
            <div class="menu-btn" onclick="openRename()"><div><i class="fas fa-pen"></i> Rename</div></div>
            <div class="menu-btn" onclick="copy()"><div><i class="fas fa-copy"></i> Copy</div></div>
            <div class="menu-btn" onclick="cut()"><div><i class="fas fa-cut"></i> Cut</div></div>
            <div class="menu-sep"></div>
            <div class="menu-btn" onclick="freezeItem('${id}')"><i class="fas fa-snowflake" style="color:#00f2fe"></i> Freeze</div>
            <div class="menu-sep"></div>
            <div class="menu-btn" style="color:var(--danger)" onclick="deleteNode()"><div><i class="fas fa-trash"></i> Delete</div></div>
        `;
        
        ctx.style.display = 'block';
        
        // Smart Positioning
        let x = e.clientX; 
        let y = e.clientY;
        const menuW = 190, menuH = 260;
        
        if (x + menuW > window.innerWidth) x = window.innerWidth - menuW - 10;
        if (y + menuH > window.innerHeight) y = window.innerHeight - menuH - 10;
        
        ctx.style.left = x + 'px'; 
        ctx.style.top = y + 'px';
    }

    function hideCtx() { ctx.style.display = 'none'; }

    // --- Actions ---
    async function submitModal() {
        const n = mInput.value.trim(); 
        if(!n) {
            mInput.style.borderColor = 'red';
            setTimeout(() => mInput.style.borderColor = '#333', 1000);
            return;
        }
        
        const oldState = JSON.parse(JSON.stringify(state.allNodes)); // Deep copy
        closeModal();

        if (state.act === 'rename') {
            // Optimistic Update
            const node = state.allNodes.find(item => item.id === state.renameId);
            if(node) node.name = n;
            render();

            const { error } = await sb.from('fs_nodes').update({ name: n }).eq('id', state.renameId);
            if(error) {
                state.allNodes = oldState; // Revert
                render();
                showToast("Rename failed");
            } else {
                showToast("Renamed successfully");
            }
        } else {
            // Creation
            const newObj = { name: n, type: state.act, pid: state.cur, store: 'main', content: '' };
            const { data, error } = await sb.from('fs_nodes').insert([newObj]).select();
            
            if(!error && data) {
                state.allNodes.push(data[0]);
                render();
                showToast(`${state.act} created`);
            } else {
                showToast("Creation failed");
            }
        }
    }

    async function deleteNode() {
        const toDeleteIds = [...state.sel];
        const oldData = JSON.parse(JSON.stringify(state.allNodes));
        
        // Optimistic UI
        state.allNodes = state.allNodes.filter(n => !toDeleteIds.includes(n.id));
        state.sel = [];
        hideCtx();
        render();

        const { error } = await sb.from('fs_nodes').delete().in('id', toDeleteIds);
        
        if(!error) {
            showToast("Item deleted", () => {
                // Custom Undo Logic
                restoreData(oldData);
            });
        } else {
            state.allNodes = oldData;
            render();
            showToast("Delete failed");
        }
    }

    async function restoreData(oldNodes) {
        // Simple restore strategy: re-fetch or push back diff
        // For simplicity, we just re-sync here or re-insert if we were building a complex undo engine
        // Here we just re-insert the deleted items from memory
        const missing = oldNodes.filter(old => !state.allNodes.find(curr => curr.id === old.id));
        if(missing.length > 0) {
           await sb.from('fs_nodes').insert(missing);
           syncData();
        }
    }

    async function saveEditor() {
        if (!state.actFile) return;
        const btn = document.querySelector('.btn-p');
        const origText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving';
        
        const newData = document.getElementById('txt-area').value;
        const { error } = await sb.from('fs_nodes').update({ content: newData }).eq('id', state.actFile);
        
        btn.innerHTML = origText;
        if(!error) {
            // Update local state too
            const localFile = state.allNodes.find(n => n.id === state.actFile);
            if(localFile) localFile.content = newData;
            showToast("File saved successfully");
        } else {
            showToast("Save failed");
        }
    }

    async function freezeItem(id) {
    hideCtx();
    const node = state.allNodes.find(n => n.id === id);
    if(!node) return;

    // UI Optimistic Remove (Agar terlihat cepat)
    const oldNodes = [...state.allNodes];
    state.allNodes = state.allNodes.filter(n => n.id !== id);
    render();

    // PERBAIKAN DI SINI:
    // Kita buat objek baru yang bersih, jangan kirim mentah-mentah "...node"
    // karena bisa jadi ada properti internal yang bikin error.
    const cleanNode = {
        name: node.name,
        type: node.type,
        content: node.content || '', // Pastikan tidak null/undefined
        pid: node.pid,
        store: 'frozen'
        // Kita biarkan Supabase membuat ID baru untuk item yang dibekukan
        // atau jika ingin ID sama, tambahkan: id: node.id
    };

    // Kirim ke tabel freeze_storage
    const { error: insErr } = await sb.from('freeze_storage').insert([cleanNode]);
    
    if(!insErr) {
        // Hapus dari tabel utama (fs_nodes)
        await sb.from('fs_nodes').delete().eq('id', id);
        showToast("Item frozen successfully");
        await syncData(); // Pastikan sinkronisasi ulang
    } else {
        // Jika gagal, kembalikan tampilan seperti semula
        console.error(insErr); // Cek console untuk detail error
        state.allNodes = oldNodes;
        render();
        showToast("Freeze failed: " + insErr.message);
    }
}

    // --- Clipboard ---
    function copy() { 
        state.clip = { type: 'copy', ids: [...state.sel] }; 
        updatePasteUI(); hideCtx(); render(); 
        showToast("Copied to clipboard");
    }
    
    function cut() { 
        state.clip = { type: 'cut', ids: [...state.sel] }; 
        updatePasteUI(); hideCtx(); render(); 
        showToast("Cut to clipboard");
    }

    function updatePasteUI() {
        const btn = document.getElementById('paste-btn');
        if(state.clip) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    async function paste() {
        if (!state.clip) return;
        const destPid = state.cur;
        
        const btn = document.getElementById('paste-btn');
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing';

        const promises = state.clip.ids.map(async (id) => {
            const node = state.allNodes.find(n => n.id === id);
            if(!node) return;

            if (state.clip.type === 'cut') {
                node.pid = destPid; // Local update
                await sb.from('fs_nodes').update({ pid: destPid }).eq('id', id);
            } else {
                // Copy logic: create new entry
                const newNode = { ...node, pid: destPid };
                delete newNode.id; // Remove ID to generate new
                delete newNode.created_at;
                await sb.from('fs_nodes').insert([newNode]);
            }
        });

        await Promise.all(promises);

        state.clip = null; 
        updatePasteUI(); 
        btn.innerHTML = '<i class="fas fa-paste"></i> Paste Here';
        
        await syncData(); 
        showToast("Items pasted");
    }

    // --- Editor & Helper ---
    function openInEditor(i) {
        state.actFile = i.id;
        document.getElementById('placeholder').style.display = 'none';
        const txt = document.getElementById('txt-area');
        const header = document.getElementById('editor-header');
        
        txt.style.display = 'block';
        txt.value = i.content || '';
        
        document.getElementById('file-title').innerText = i.name;
        
        // Smooth fade in
        header.style.visibility = 'visible';
        header.style.opacity = '1';

        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }
    }

    function closeEditor() {
        document.getElementById('placeholder').style.display = 'flex';
        document.getElementById('txt-area').style.display = 'none';
        const header = document.getElementById('editor-header');
        header.style.opacity = '0';
        header.style.visibility = 'hidden';
        state.actFile = null;
    }

    // --- Modal Logic (Optimized) ---
    function openSlide(id) {
        const el = document.getElementById(id); 
        // Force Reflow logic not needed with simple class toggle if CSS is correct
        el.classList.add('active');
        if(id === 'modal-box') setTimeout(() => mInput.focus(), 100);
    }
    
    function closeSlide(id) {
        const el = document.getElementById(id); 
        el.classList.remove('active');
    }

    function openAddModal() { openSlide('add-modal'); }
    function closeAddModal() { closeSlide('add-modal'); }
    function closeModal() { closeSlide('modal-box'); }

    function openRename() {
        const item = state.allNodes.find(n => n.id === state.sel[0]);
        state.act = 'rename'; 
        state.renameId = item.id;
        document.getElementById('modal-h').innerText = 'Rename Item';
        mInput.value = item.name; 
        hideCtx();
        openSlide('modal-box');
    }

    function setCreateType(t) { 
        state.act = t; 
        closeAddModal(); 
        document.getElementById('modal-h').innerText = 'New ' + (t.charAt(0).toUpperCase() + t.slice(1));
        mInput.value = ''; 
        openSlide('modal-box'); 
    }

    function updateSelectionUI() { 
        document.querySelectorAll('.item').forEach(el => {
            if(state.sel.includes(el.dataset.id)) el.classList.add('selected');
            else el.classList.remove('selected');
        });
    }

    function showToast(msg, undoCallback) {
        const id = Date.now();
        const html = `
            <div class="toast" id="t-${id}">
                <span style="flex:1; font-size:13px">${msg}</span>
                ${undoCallback ? `<button class="btn-icon" style="color:var(--accent); font-weight:bold; font-size:12px">UNDO</button>` : ''}
            </div>`;
        
        const container = document.getElementById('toast-container');
        container.insertAdjacentHTML('beforeend', html);
        
        const el = document.getElementById(`t-${id}`);
        if(undoCallback) {
            el.querySelector('button').onclick = () => {
                undoCallback();
                el.remove();
            };
        }
        
        // Auto remove
        setTimeout(() => {
            if(el && el.parentNode) {
                el.style.opacity = '0';
                el.style.transform = 'translateY(10px)';
                setTimeout(() => el.remove(), 300);
            }
        }, 3500);
    }

    // Init
    document.addEventListener('click', hideCtx);
    syncData();
</script>
</body>
</html>
